<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML>
<HEAD>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<TITLE>Autodesk DWF Core Library</TITLE>
</HEAD>
<BODY>
<table border="0" cellpadding="0" cellspacing="0" width="100%" height="140">
	<tr>
		<td background="header.png">&nbsp;</td>
	</tr>
</table>
<!--
	<div class="headingImgcontainer"><img class="headingImg" src="header.png" alt="Autodesk DWF Core Library" title="Autodesk DWF Core Library" border="0" hspace="0" vspace="0"></div>
-->
</BODY>
</HTML>
<!-- Generated by Doxygen 1.4.5 -->
<div class="tabs">
  <ul>
    <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="annotated.html"><span>Classes</span></a></li>
    <li id="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="dirs.html"><span>Directories</span></a></li>
  </ul></div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
  </ul></div>
<div class="nav">
<a class="el" href="dir_D_3A_2FStage_2FComponents76_5FC052_5Fstage_2Fdevelop_2Fglobal_2Fsrc_2F.html">src</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_D_3A_2FStage_2FComponents76_5FC052_5Fstage_2Fdevelop_2Fglobal_2Fsrc_2Fdwf_2F.html">dwf</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_D_3A_2FStage_2FComponents76_5FC052_5Fstage_2Fdevelop_2Fglobal_2Fsrc_2Fdwf_2Fw3dtk_2F.html">w3dtk</a></div>
<h1>BByteStream.h</h1><a href="_b_byte_stream_8h.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">//</span>
<a name="l00002"></a>00002 <span class="comment">// Copyright (c) 2000 by Tech Soft 3D, LLC.</span>
<a name="l00003"></a>00003 <span class="comment">// The information contained herein is confidential and proprietary to</span>
<a name="l00004"></a>00004 <span class="comment">// Tech Soft 3D, LLC., and considered a trade secret as defined under</span>
<a name="l00005"></a>00005 <span class="comment">// civil and criminal statutes.  Tech Soft 3D shall pursue its civil</span>
<a name="l00006"></a>00006 <span class="comment">// and criminal remedies in the event of unauthorized use or misappropriation</span>
<a name="l00007"></a>00007 <span class="comment">// of its trade secrets.  Use of this information by anyone other than</span>
<a name="l00008"></a>00008 <span class="comment">// authorized employees of Tech Soft 3D, LLC. is granted only under a</span>
<a name="l00009"></a>00009 <span class="comment">// written non-disclosure agreement, expressly prescribing the scope and</span>
<a name="l00010"></a>00010 <span class="comment">// manner of such use.</span>
<a name="l00011"></a>00011 <span class="comment">//</span>
<a name="l00012"></a>00012 <span class="comment">// $Header: //DWF/Working_Area/Willie.Zhu/w3dtk/BByteStream.h#1 $</span>
<a name="l00013"></a>00013 <span class="comment">//</span>
<a name="l00014"></a>00014 <span class="comment">// This header file is a completely self-contained class that defines all of the</span>
<a name="l00015"></a>00015 <span class="comment">// member functions that it needs inside the declaration.  It is just a utility class</span>
<a name="l00016"></a>00016 <span class="comment">// to stuff unaligned data values into bytes.</span>
<a name="l00017"></a>00017 <span class="comment">//</span>
<a name="l00018"></a>00018 
<a name="l00019"></a>00019 <span class="preprocessor">#ifndef _B_BYTE_STREAM_H_</span>
<a name="l00020"></a>00020 <span class="preprocessor"></span><span class="preprocessor">#define _B_BYTE_STREAM_H_</span>
<a name="l00021"></a>00021 <span class="preprocessor"></span>
<a name="l00025"></a>00025 
<a name="l00026"></a>00026 
<a name="l00027"></a>00027 <span class="preprocessor">#ifndef STATUS_ERROR</span>
<a name="l00028"></a><a class="code" href="_b_byte_stream_8h.html#c01289a7e6e2f258f7de3f16399fd5f1">00028</a> <span class="preprocessor"></span><span class="preprocessor">#  define STATUS_ERROR 0</span>
<a name="l00029"></a>00029 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00030"></a>00030 <span class="preprocessor"></span><span class="preprocessor">#ifndef STATUS_NORMAL</span>
<a name="l00031"></a><a class="code" href="_b_byte_stream_8h.html#50a45fb127a574234d22eae4a80122b9">00031</a> <span class="preprocessor"></span><span class="preprocessor">#  define STATUS_NORMAL 1</span>
<a name="l00032"></a>00032 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00033"></a>00033 <span class="preprocessor"></span>
<a name="l00034"></a>00034 <span class="preprocessor">#ifdef __APPLE_CC__</span>
<a name="l00035"></a>00035 <span class="preprocessor"></span><span class="preprocessor">        #ifdef __i386__</span>
<a name="l00036"></a>00036 <span class="preprocessor"></span><span class="preprocessor">                #undef STREAM_BIGENDIAN</span>
<a name="l00037"></a>00037 <span class="preprocessor"></span><span class="preprocessor">        #else</span>
<a name="l00038"></a>00038 <span class="preprocessor"></span><span class="preprocessor">                #define STREAM_BIGENDIAN</span>
<a name="l00039"></a>00039 <span class="preprocessor"></span><span class="preprocessor">        #endif</span>
<a name="l00040"></a>00040 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00041"></a>00041 <span class="preprocessor"></span>
<a name="l00043"></a>00043 
<a name="l00065"></a><a class="code" href="class_b_byte_stream.html">00065</a> <span class="keyword">class </span><a class="code" href="class_b_byte_stream.html">BByteStream</a> {
<a name="l00066"></a>00066   <span class="keyword">private</span>:
<a name="l00067"></a>00067     <span class="keywordtype">int</span> byteplace;      
<a name="l00068"></a>00068     <span class="keywordtype">int</span> bitplace;       
<a name="l00069"></a>00069     <span class="keywordtype">int</span> bitsperval;     
<a name="l00070"></a>00070     <span class="keywordtype">int</span> allocated;      
<a name="l00071"></a>00071     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *data;    
<a name="l00072"></a>00072     <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> mask;    
<a name="l00073"></a>00073   <span class="keyword">public</span>:
<a name="l00074"></a><a class="code" href="class_b_byte_stream.html#2e53cb347d49575b2c328b56c037f9a1">00074</a>     <a class="code" href="class_b_byte_stream.html#5f16c4640c3975614785153d8797aefa">BByteStream</a>(<span class="keywordtype">int</span> size, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *cptr, <span class="keywordtype">int</span> bpv) {
<a name="l00075"></a>00075         <span class="keywordflow">if</span>( bpv == 9 || bpv == 10 || bpv == 12 ) {
<a name="l00076"></a>00076             allocated = size;
<a name="l00077"></a>00077             data = cptr; 
<a name="l00078"></a>00078             bitsperval = bpv;
<a name="l00079"></a>00079             byteplace = 0;
<a name="l00080"></a>00080             bitplace = 16 - bitsperval; 
<a name="l00081"></a>00081             mask = (<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>)((1&lt;&lt;bitsperval)-1);
<a name="l00082"></a>00082         }
<a name="l00083"></a>00083         <span class="keywordflow">else</span> {
<a name="l00084"></a>00084             <span class="comment">//do nothing.  we deserve the crash.</span>
<a name="l00085"></a>00085             data = 0;
<a name="l00086"></a>00086         }
<a name="l00087"></a>00087     };
<a name="l00088"></a><a class="code" href="class_b_byte_stream.html#5f16c4640c3975614785153d8797aefa">00088</a>     <a class="code" href="class_b_byte_stream.html">BByteStream</a>() { <a class="code" href="jpeglib_8h.html#8d777f385d3dfec8815d20f7496026dc">data</a> = NULL; };
<a name="l00089"></a>00089     <span class="comment">/*&lt; write a sample */</span>
<a name="l00090"></a><a class="code" href="class_b_byte_stream.html#17f2abb0270ebce8ecb78f91f50ba94d">00090</a>     <span class="keywordtype">void</span> put(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> value) <a class="code" href="_b_stream_8h.html#5667da2ff3545d244af39297559ee21e">alter</a> {
<a name="l00091"></a>00091         <a class="code" href="jpeglib_8h.html#8d777f385d3dfec8815d20f7496026dc">data</a>[byteplace] |= (value &gt;&gt; (8 - bitplace));
<a name="l00092"></a>00092         <a class="code" href="jpeglib_8h.html#8d777f385d3dfec8815d20f7496026dc">data</a>[byteplace+1] |= (value &lt;&lt; bitplace);
<a name="l00093"></a>00093         bitplace -= bitsperval - 8;
<a name="l00094"></a>00094         <span class="keywordflow">if</span>( bitplace &lt; 0 ) {
<a name="l00095"></a>00095             byteplace += 2; <span class="comment">// consume two bytes</span>
<a name="l00096"></a>00096             bitplace += 8;
<a name="l00097"></a>00097         }
<a name="l00098"></a>00098         <span class="keywordflow">else</span>
<a name="l00099"></a>00099             byteplace++; <span class="comment">// consume one byte</span>
<a name="l00100"></a>00100     };      
<a name="l00102"></a><a class="code" href="class_b_byte_stream.html#b5eb2638aaf5282b242076bc6c85e3cc">00102</a>     <span class="keywordtype">void</span> get(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <a class="code" href="_b_stream_8h.html#5667da2ff3545d244af39297559ee21e">alter</a> &amp;value) {
<a name="l00103"></a>00103         value = (<span class="keywordtype">unsigned</span> short)((<a class="code" href="jpeglib_8h.html#8d777f385d3dfec8815d20f7496026dc">data</a>[byteplace] &lt;&lt; 8) | (<a class="code" href="jpeglib_8h.html#8d777f385d3dfec8815d20f7496026dc">data</a>[byteplace + 1]));
<a name="l00104"></a>00104         value = (<span class="keywordtype">unsigned</span> short)((value &gt;&gt; bitplace) &amp; mask );
<a name="l00105"></a>00105         bitplace -= bitsperval - 8;
<a name="l00106"></a>00106         <span class="keywordflow">if</span>( bitplace &lt; 0 ) {
<a name="l00107"></a>00107             byteplace += 2; <span class="comment">// consume two bytes</span>
<a name="l00108"></a>00108             bitplace += 8;
<a name="l00109"></a>00109         }
<a name="l00110"></a>00110         <span class="keywordflow">else</span>
<a name="l00111"></a>00111             byteplace++; <span class="comment">// consume one byte</span>
<a name="l00112"></a>00112     }; 
<a name="l00113"></a>00113 
<a name="l00114"></a>00114 }; <span class="comment">//end declaration of class BByteStream</span>
<a name="l00115"></a>00115 
<a name="l00116"></a>00116 
<a name="l00117"></a>00117 
<a name="l00127"></a><a class="code" href="class_b_var_stream.html">00127</a> <span class="keyword">class</span> <a class="code" href="class_b_var_stream.html">BVarStream</a> {
<a name="l00128"></a>00128   <span class="keyword">private</span>:
<a name="l00129"></a>00129     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *m_data;   
<a name="l00130"></a>00130     <span class="keywordtype">int</span> m_allocated;        
<a name="l00131"></a>00131     <span class="keywordtype">int</span> m_used;             
<a name="l00132"></a>00132     <span class="keywordtype">int</span> m_bit;              
<a name="l00133"></a>00133     <span class="keywordtype">int</span> m_rused;            
<a name="l00134"></a>00134     <span class="keywordtype">int</span> m_rbit;             
<a name="l00135"></a>00135     <span class="keywordtype">int</span> m_can_reallocate;   
<a name="l00136"></a>00136     <span class="keywordtype">int</span> m_status;           
<a name="l00137"></a>00137     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> m_mask[33];  
<a name="l00138"></a>00138     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> m_range[33]; 
<a name="l00142"></a>00142     <span class="keywordtype">void</span> Reset() {
<a name="l00143"></a>00143         <span class="keywordtype">int</span> i;
<a name="l00144"></a>00144         m_data = 0;
<a name="l00145"></a>00145         m_allocated = 0;
<a name="l00146"></a>00146         m_used = 0;
<a name="l00147"></a>00147         m_bit = 0;
<a name="l00148"></a>00148         m_rused = 0;
<a name="l00149"></a>00149         m_rbit = 0;
<a name="l00150"></a>00150         m_can_reallocate = 0;
<a name="l00151"></a>00151         m_status = <a class="code" href="_b_byte_stream_8h.html#50a45fb127a574234d22eae4a80122b9">STATUS_NORMAL</a>;
<a name="l00152"></a>00152         m_mask[0] = 0;
<a name="l00153"></a>00153         m_range[0] = 0;
<a name="l00154"></a>00154         <span class="keywordflow">for</span>( i = 1 ; i &lt;= 32 ; i++ ) {
<a name="l00155"></a>00155             m_mask[i] = ((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)(-1)) &gt;&gt; (32-i);
<a name="l00156"></a>00156             m_range[i] = (0x1 &lt;&lt; (i-1)) - 1;
<a name="l00157"></a>00157         }
<a name="l00158"></a>00158     };
<a name="l00159"></a>00159 
<a name="l00161"></a>00161 <span class="preprocessor">    #ifdef STREAM_BIGENDIAN</span>
<a name="l00162"></a>00162 <span class="preprocessor"></span><span class="preprocessor">        #ifndef SWAP32</span>
<a name="l00163"></a>00163 <span class="preprocessor"></span><span class="preprocessor">            #define SWAP32(i) (\</span>
<a name="l00164"></a>00164 <span class="preprocessor">                (((i) &gt;&gt; 24) &amp; 0x000000ff) |\</span>
<a name="l00165"></a>00165 <span class="preprocessor">                (((i) &amp; 0x00ff0000) &gt;&gt; 8) |\</span>
<a name="l00166"></a>00166 <span class="preprocessor">                (((i) &amp; 0x0000ff00) &lt;&lt; 8) |\</span>
<a name="l00167"></a>00167 <span class="preprocessor">                ((i) &lt;&lt; 24) \</span>
<a name="l00168"></a>00168 <span class="preprocessor">                )</span>
<a name="l00169"></a>00169 <span class="preprocessor"></span><span class="preprocessor">            #endif</span>
<a name="l00170"></a>00170 <span class="preprocessor"></span>    <span class="keywordtype">void</span> SwapBytes( ) 
<a name="l00171"></a>00171     {
<a name="l00172"></a>00172         <span class="keywordtype">int</span> i;
<a name="l00173"></a>00173         <span class="keywordflow">for</span>( i = 0 ; i &lt; m_allocated ; i++ )
<a name="l00174"></a>00174             m_data[i] = SWAP32( m_data[i] );
<a name="l00175"></a>00175     };
<a name="l00176"></a>00176 <span class="preprocessor">#   else</span>
<a name="l00177"></a>00177 <span class="preprocessor"></span>    <span class="keyword">inline</span> <span class="keywordtype">void</span> SwapBytes() {};
<a name="l00178"></a>00178 <span class="preprocessor">#   endif</span>
<a name="l00179"></a>00179 <span class="preprocessor"></span>
<a name="l00181"></a>00181     <span class="keywordtype">void</span> Reallocate( )
<a name="l00182"></a>00182     {
<a name="l00183"></a>00183 
<a name="l00184"></a>00184         <span class="keywordflow">if</span>( m_can_reallocate ) {
<a name="l00185"></a>00185             <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *temp;
<a name="l00186"></a>00186             m_allocated *= 2;
<a name="l00187"></a>00187             temp = <span class="keyword">new</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>[ m_allocated ];
<a name="l00188"></a>00188             <span class="keywordflow">if</span>( temp == NULL ) {
<a name="l00189"></a>00189                 <span class="comment">/* Allocation failed.  Declare error, jettison all data to avoid a seg fault */</span>
<a name="l00190"></a>00190                 m_status = <a class="code" href="_b_byte_stream_8h.html#c01289a7e6e2f258f7de3f16399fd5f1">STATUS_ERROR</a>;
<a name="l00191"></a>00191                 m_used = 0; 
<a name="l00192"></a>00192             }
<a name="l00193"></a>00193             <span class="keywordflow">else</span> {
<a name="l00194"></a>00194                 memcpy( temp, m_data, (m_used+1) * <span class="keyword">sizeof</span>( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ) );
<a name="l00195"></a>00195                 <span class="keyword">delete</span> [] m_data;
<a name="l00196"></a>00196                 m_data = temp;
<a name="l00197"></a>00197             }
<a name="l00198"></a>00198         }
<a name="l00199"></a>00199         <span class="keywordflow">else</span> {
<a name="l00200"></a>00200             <span class="comment">/* We don't own the poitner. Declare error, jettison all data to avoid a seg fault */</span>
<a name="l00201"></a>00201             m_status = <a class="code" href="_b_byte_stream_8h.html#c01289a7e6e2f258f7de3f16399fd5f1">STATUS_ERROR</a>;
<a name="l00202"></a>00202             m_used = 0;
<a name="l00203"></a>00203         }
<a name="l00204"></a>00204     };
<a name="l00205"></a>00205 
<a name="l00207"></a>00207     <span class="keywordtype">void</span> Put2( <span class="keywordtype">int</span> numbits, <span class="keywordtype">int</span> <a class="code" href="jpeglib_8h.html#3a6d0284e743dc4a9b86f97d6dd1a3bf">val</a> ) 
<a name="l00208"></a>00208     {
<a name="l00209"></a>00209         <span class="keywordflow">if</span>( m_bit + numbits &lt;= 32 ) {
<a name="l00210"></a>00210             m_data[m_used] |= val &lt;&lt; (32 - m_bit - numbits);
<a name="l00211"></a>00211             m_bit += numbits;
<a name="l00212"></a>00212         }
<a name="l00213"></a>00213         <span class="keywordflow">else</span> {
<a name="l00214"></a>00214             <span class="keywordtype">int</span> shift = (numbits + m_bit - 32);
<a name="l00215"></a>00215 
<a name="l00216"></a>00216             <span class="keywordflow">if</span>( m_used + 1 &gt;= m_allocated )
<a name="l00217"></a>00217                 Reallocate( );
<a name="l00218"></a>00218             m_data[m_used++] |= val &gt;&gt; shift;
<a name="l00219"></a>00219             m_data[m_used] = val &lt;&lt; (32-shift);
<a name="l00220"></a>00220             m_bit += numbits - 32;
<a name="l00221"></a>00221         }
<a name="l00222"></a>00222     };
<a name="l00223"></a>00223 
<a name="l00225"></a>00225     <span class="keywordtype">void</span> Get2( <span class="keywordtype">int</span> numbits, <span class="keywordtype">int</span> *val ) 
<a name="l00226"></a>00226     {
<a name="l00227"></a>00227         <span class="keywordflow">if</span>( m_rbit + numbits &lt;= 32 ) {
<a name="l00228"></a>00228             *val = (m_data[m_rused] &gt;&gt; (32 - m_rbit - numbits)) &amp; m_mask[numbits];
<a name="l00229"></a>00229             m_rbit += numbits;
<a name="l00230"></a>00230         }
<a name="l00231"></a>00231         <span class="keywordflow">else</span> {
<a name="l00232"></a>00232             <span class="keywordtype">int</span> shift = (numbits + m_rbit - 32);
<a name="l00233"></a>00233             *val = (m_data[m_rused++] &lt;&lt; shift) &amp; m_mask[numbits];
<a name="l00234"></a>00234             *val |= m_data[m_rused] &gt;&gt; (32-shift);
<a name="l00235"></a>00235             m_rbit += numbits - 32;
<a name="l00236"></a>00236         }
<a name="l00237"></a>00237     };
<a name="l00238"></a>00238 
<a name="l00239"></a>00239 
<a name="l00240"></a>00240   <span class="keyword">public</span>:
<a name="l00241"></a>00241 
<a name="l00242"></a><a class="code" href="class_b_var_stream.html#7d17de0f2b6f1a43371731d34dadd218">00242</a>     <a class="code" href="class_b_var_stream.html">BVarStream</a>() {
<a name="l00243"></a>00243         m_can_reallocate = 0;
<a name="l00244"></a>00244         m_data = NULL;
<a name="l00245"></a>00245     };
<a name="l00246"></a>00246 
<a name="l00247"></a><a class="code" href="class_b_var_stream.html#f4fdabaaf98fddbddd04fa7d2f052adb">00247</a>     ~<a class="code" href="class_b_var_stream.html">BVarStream</a>( )
<a name="l00248"></a>00248     {
<a name="l00249"></a>00249         <span class="keywordflow">if</span>( m_data != NULL ) {
<a name="l00250"></a>00250             <span class="keywordflow">if</span>( m_can_reallocate )
<a name="l00251"></a>00251                 <span class="keyword">delete</span> [] m_data;
<a name="l00252"></a>00252             m_data = NULL;
<a name="l00253"></a>00253         }
<a name="l00254"></a>00254     };
<a name="l00255"></a>00255 
<a name="l00260"></a><a class="code" href="class_b_var_stream.html#9090e9388b5e2000e8055a70ec0b7f64">00260</a>     <span class="keywordtype">void</span> InitWrite( <span class="keywordtype">int</span> size, <span class="keywordtype">void</span> *pointer ) {
<a name="l00261"></a>00261         Reset();
<a name="l00262"></a>00262         m_allocated = size/4;
<a name="l00263"></a>00263         m_data = (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *) pointer;
<a name="l00264"></a>00264         m_data[0] = 0;
<a name="l00265"></a>00265         m_can_reallocate = 1;
<a name="l00266"></a>00266     };
<a name="l00267"></a>00267 
<a name="l00272"></a><a class="code" href="class_b_var_stream.html#8d9282818ddc4917580b757f9f37f205">00272</a>     <span class="keywordtype">void</span> InitRead( <span class="keywordtype">int</span> size, <span class="keyword">const</span> <span class="keywordtype">void</span> *pointer )
<a name="l00273"></a>00273     {
<a name="l00274"></a>00274         Reset();
<a name="l00275"></a>00275         m_allocated = size/4;
<a name="l00276"></a>00276         m_data = (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *) pointer;
<a name="l00277"></a>00277         m_can_reallocate = 0;
<a name="l00278"></a>00278     };
<a name="l00279"></a>00279 
<a name="l00284"></a><a class="code" href="class_b_var_stream.html#1d4ab6aae89a6c303ba489a194d0f2d8">00284</a>     <span class="keywordtype">int</span> Put( <span class="keywordtype">int</span> *numbits_array, <span class="keywordtype">int</span> val )
<a name="l00285"></a>00285     {
<a name="l00286"></a>00286         <span class="keywordtype">int</span> temprange = 0, i;
<a name="l00287"></a>00287 
<a name="l00288"></a>00288         i = 0;
<a name="l00289"></a>00289         <span class="keywordflow">for</span>(;;){
<a name="l00290"></a>00290             temprange = m_range[ numbits_array[i] ];
<a name="l00291"></a>00291             <span class="keywordflow">if</span>( val &lt; -temprange || val &gt; temprange ) {
<a name="l00292"></a>00292                 <span class="comment">/* Put an escape sequence as a signal to "fall back to the next level" */</span>
<a name="l00293"></a>00293                 Put2( numbits_array[i], m_mask[ numbits_array[i] ] );
<a name="l00294"></a>00294                 i++;
<a name="l00295"></a>00295             }
<a name="l00296"></a>00296             <span class="keywordflow">else</span> {
<a name="l00297"></a>00297                 <span class="comment">/* Put the real data.  We've found a range that works, so we're done. */</span>
<a name="l00298"></a>00298                 Put2( numbits_array[i], val+temprange );
<a name="l00299"></a>00299                 <span class="keywordflow">break</span>;
<a name="l00300"></a>00300             }
<a name="l00301"></a>00301         }
<a name="l00302"></a>00302         <span class="keywordflow">return</span> m_status;
<a name="l00303"></a>00303     };
<a name="l00304"></a>00304 
<a name="l00311"></a><a class="code" href="class_b_var_stream.html#a0e180faf298bcdbfc3a44d39aa0a2be">00311</a>     <span class="keywordtype">int</span> Get( <span class="keywordtype">int</span> *numbits_array ) 
<a name="l00312"></a>00312     {
<a name="l00313"></a>00313         <span class="keywordtype">int</span> i = 0;
<a name="l00314"></a>00314         <span class="keywordtype">int</span> val;
<a name="l00315"></a>00315 
<a name="l00316"></a>00316         <span class="keywordflow">for</span>(;;) {
<a name="l00317"></a>00317             Get2( numbits_array[i], &amp;val );
<a name="l00318"></a>00318             <span class="keywordflow">if</span>( val == (int)m_mask[ numbits_array[i] ] )
<a name="l00319"></a>00319                 i++;
<a name="l00320"></a>00320             <span class="keywordflow">else</span>
<a name="l00321"></a>00321                 <span class="keywordflow">break</span>;
<a name="l00322"></a>00322         }
<a name="l00323"></a>00323         val -= m_range[ numbits_array[i] ];
<a name="l00324"></a>00324         <span class="keywordflow">return</span> val;
<a name="l00325"></a>00325     };
<a name="l00326"></a>00326 
<a name="l00327"></a>00327 }; <span class="comment">/* end definition of class BVarStream */</span>
<a name="l00328"></a>00328 
<a name="l00329"></a>00329 
<a name="l00330"></a>00330 
<a name="l00331"></a>00331 
<a name="l00343"></a><a class="code" href="class_b_pack.html">00343</a> <span class="keyword">class </span><a class="code" href="class_b_pack.html">BPack</a> {
<a name="l00344"></a>00344   <span class="keyword">private</span>:
<a name="l00345"></a>00345     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *m_data; 
<a name="l00346"></a>00346     <span class="keywordtype">int</span> m_allocated;    
<a name="l00347"></a>00347     <span class="keywordtype">int</span> m_used;     
<a name="l00348"></a>00348     <span class="keywordtype">int</span> m_bit;      
<a name="l00349"></a>00349     <span class="keywordtype">int</span> m_rused;        
<a name="l00350"></a>00350     <span class="keywordtype">int</span> m_rbit;     
<a name="l00351"></a>00351     <span class="keywordtype">int</span> m_can_reallocate; 
<a name="l00352"></a>00352     <span class="keywordtype">int</span> m_status;       
<a name="l00353"></a>00353     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> m_mask[33]; 
<a name="l00354"></a>00354     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> m_range[33]; 
<a name="l00358"></a>00358     <span class="keywordtype">void</span> Reset() {
<a name="l00359"></a>00359         <span class="keywordtype">int</span> i;
<a name="l00360"></a>00360         m_data = 0;
<a name="l00361"></a>00361         m_allocated = 0;
<a name="l00362"></a>00362         m_used = 0;
<a name="l00363"></a>00363         m_bit = 0;
<a name="l00364"></a>00364         m_rused = 0;
<a name="l00365"></a>00365         m_rbit = 0;
<a name="l00366"></a>00366         m_can_reallocate = 0;
<a name="l00367"></a>00367         m_status = <a class="code" href="_b_byte_stream_8h.html#50a45fb127a574234d22eae4a80122b9">STATUS_NORMAL</a>;
<a name="l00368"></a>00368         m_mask[0] = 0;
<a name="l00369"></a>00369         m_range[0] = 0;
<a name="l00370"></a>00370         <span class="keywordflow">for</span>( i = 1 ; i &lt;= 32 ; i++ ) {
<a name="l00371"></a>00371             m_mask[i] = ((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)(-1)) &gt;&gt; (32-i);
<a name="l00372"></a>00372             m_range[i] = (0x1 &lt;&lt; (i-1)) - 1;
<a name="l00373"></a>00373         }
<a name="l00374"></a>00374     };
<a name="l00375"></a>00375 
<a name="l00377"></a>00377     <span class="keywordtype">void</span> Reallocate( )
<a name="l00378"></a>00378     {
<a name="l00379"></a>00379 
<a name="l00380"></a>00380         <span class="keywordflow">if</span>( m_can_reallocate ) {
<a name="l00381"></a>00381             <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *temp;
<a name="l00382"></a>00382             m_allocated *= 2;
<a name="l00383"></a>00383             temp = <span class="keyword">new</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>[ m_allocated ];
<a name="l00384"></a>00384             <span class="keywordflow">if</span>( temp == NULL ) {
<a name="l00385"></a>00385                 <span class="comment">/* Allocation failed.  Declare error, jettison all data to avoid a seg fault */</span>
<a name="l00386"></a>00386                 m_status = <a class="code" href="_b_byte_stream_8h.html#c01289a7e6e2f258f7de3f16399fd5f1">STATUS_ERROR</a>;
<a name="l00387"></a>00387                 m_used = 0; 
<a name="l00388"></a>00388             }
<a name="l00389"></a>00389             <span class="keywordflow">else</span> {
<a name="l00390"></a>00390                 memcpy( temp, m_data, (m_used+1) * <span class="keyword">sizeof</span>( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ) );
<a name="l00391"></a>00391                 <span class="keyword">delete</span> [] m_data;
<a name="l00392"></a>00392                 m_data = temp;
<a name="l00393"></a>00393             }
<a name="l00394"></a>00394         }
<a name="l00395"></a>00395         <span class="keywordflow">else</span> {
<a name="l00396"></a>00396             <span class="comment">/* We don't own the poitner. Declare error, jettison all data to avoid a seg fault */</span>
<a name="l00397"></a>00397             m_status = <a class="code" href="_b_byte_stream_8h.html#c01289a7e6e2f258f7de3f16399fd5f1">STATUS_ERROR</a>;
<a name="l00398"></a>00398             m_used = 0;
<a name="l00399"></a>00399         }
<a name="l00400"></a>00400     };
<a name="l00401"></a>00401 
<a name="l00402"></a>00402 
<a name="l00403"></a>00403 
<a name="l00404"></a>00404   <span class="keyword">public</span>:
<a name="l00405"></a>00405 
<a name="l00406"></a><a class="code" href="class_b_pack.html#2727df306ac78a2e24439de85a1b251d">00406</a>     <a class="code" href="class_b_pack.html">BPack</a>() { 
<a name="l00407"></a>00407         m_can_reallocate = 0;
<a name="l00408"></a>00408         m_data = NULL;
<a name="l00409"></a>00409     };
<a name="l00410"></a>00410 
<a name="l00411"></a><a class="code" href="class_b_pack.html#ef66e63d7b23100d827175e7853e3fff">00411</a>     ~<a class="code" href="class_b_pack.html">BPack</a>( ) {
<a name="l00412"></a>00412         <span class="keywordflow">if</span>( m_data != NULL ) {
<a name="l00413"></a>00413             <span class="keywordflow">if</span>( m_can_reallocate )
<a name="l00414"></a>00414                 <span class="keyword">delete</span> [] m_data;
<a name="l00415"></a>00415             m_data = NULL;
<a name="l00416"></a>00416         }
<a name="l00417"></a>00417     };
<a name="l00418"></a>00418 
<a name="l00423"></a><a class="code" href="class_b_pack.html#9090e9388b5e2000e8055a70ec0b7f64">00423</a>     <span class="keywordtype">void</span> InitWrite( <span class="keywordtype">int</span> size, <span class="keywordtype">void</span> *pointer ) {
<a name="l00424"></a>00424         Reset();
<a name="l00425"></a>00425         m_allocated = size/4;
<a name="l00426"></a>00426         m_data = (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *) pointer;
<a name="l00427"></a>00427         <span class="keywordflow">if</span> (m_data) m_data[0] = 0;
<a name="l00428"></a>00428         m_can_reallocate = 0;
<a name="l00429"></a>00429     };
<a name="l00430"></a>00430 
<a name="l00435"></a><a class="code" href="class_b_pack.html#8d9282818ddc4917580b757f9f37f205">00435</a>     <span class="keywordtype">void</span> InitRead( <span class="keywordtype">int</span> size, <span class="keyword">const</span> <span class="keywordtype">void</span> *pointer )
<a name="l00436"></a>00436     {
<a name="l00437"></a>00437         Reset();
<a name="l00438"></a>00438         m_allocated = size/4;
<a name="l00439"></a>00439         m_data = (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *) pointer;
<a name="l00440"></a>00440         m_can_reallocate = 0;
<a name="l00441"></a>00441     };
<a name="l00442"></a>00442 
<a name="l00443"></a><a class="code" href="class_b_pack.html#08a77d213d5c6431f9155c5dcf23ed87">00443</a>     <span class="keywordtype">void</span> Put( <span class="keywordtype">int</span> numbits, <span class="keywordtype">int</span> val ) 
<a name="l00444"></a>00444     {
<a name="l00445"></a>00445         <span class="keywordflow">if</span>( m_bit + numbits &lt;= 32 ) {
<a name="l00446"></a>00446             m_data[m_used] |= val &lt;&lt; (32 - m_bit - numbits);
<a name="l00447"></a>00447             m_bit += numbits;
<a name="l00448"></a>00448         }
<a name="l00449"></a>00449         <span class="keywordflow">else</span> {
<a name="l00450"></a>00450             <span class="keywordtype">int</span> shift = (numbits + m_bit - 32);
<a name="l00451"></a>00451 
<a name="l00452"></a>00452             <span class="keywordflow">if</span>( m_used + 1 &gt;= m_allocated )
<a name="l00453"></a>00453                 Reallocate( );
<a name="l00454"></a>00454             m_data[m_used++] |= val &gt;&gt; shift;
<a name="l00455"></a>00455             m_data[m_used] = val &lt;&lt; (32-shift);
<a name="l00456"></a>00456             m_bit += numbits - 32;
<a name="l00457"></a>00457         }
<a name="l00458"></a>00458     };
<a name="l00459"></a>00459 
<a name="l00460"></a><a class="code" href="class_b_pack.html#2d9b5101c599d0abdac9b54f80442b3b">00460</a>     <span class="keywordtype">int</span> Get( <span class="keywordtype">int</span> numbits ) 
<a name="l00461"></a>00461     {
<a name="l00462"></a>00462         <span class="keywordtype">int</span> return_val;
<a name="l00463"></a>00463 
<a name="l00464"></a>00464         <span class="keywordflow">if</span>( m_rbit + numbits &lt;= 32 ) {
<a name="l00465"></a>00465             return_val = (m_data[m_rused] &gt;&gt; (32 - m_rbit - numbits)) &amp; m_mask[numbits];
<a name="l00466"></a>00466             m_rbit += numbits;
<a name="l00467"></a>00467         }
<a name="l00468"></a>00468         <span class="keywordflow">else</span> {
<a name="l00469"></a>00469             <span class="keywordtype">int</span> shift = (numbits + m_rbit - 32);
<a name="l00470"></a>00470             return_val = (m_data[m_rused++] &lt;&lt; shift) &amp; m_mask[numbits];
<a name="l00471"></a>00471             return_val |= m_data[m_rused] &gt;&gt; (32-shift);
<a name="l00472"></a>00472             m_rbit += numbits - 32;
<a name="l00473"></a>00473         }
<a name="l00474"></a>00474         <span class="keywordflow">return</span> return_val;
<a name="l00475"></a>00475     };
<a name="l00476"></a>00476 
<a name="l00477"></a><a class="code" href="class_b_pack.html#87ec14b0ab7d0e0ec6c1f719227d59a7">00477</a>     <span class="keywordtype">int</span> NumBytes() <span class="keyword">const</span> { <span class="keywordflow">return</span> (m_used+(m_bit?1:0)) * 4; };
<a name="l00478"></a><a class="code" href="class_b_pack.html#6bbd7d973e0bda9dc1b9817b5cebf2fc">00478</a>     <span class="keywordtype">void</span> SetCanReallocate(<span class="keywordtype">int</span> val) <a class="code" href="_b_stream_8h.html#5667da2ff3545d244af39297559ee21e">alter</a> { m_can_reallocate = val; };
<a name="l00479"></a><a class="code" href="class_b_pack.html#1bdfa8211a4abc4cbbfce7db2fd16aff">00479</a>     <span class="keywordtype">int</span> GetStatus()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> m_status; };
<a name="l00480"></a>00480 
<a name="l00482"></a>00482 <span class="preprocessor">    #ifdef STREAM_BIGENDIAN</span>
<a name="l00483"></a>00483 <span class="preprocessor"></span>        <span class="keywordtype">void</span> SwapBytes( ) 
<a name="l00484"></a>00484         {
<a name="l00485"></a>00485             <span class="keywordtype">int</span> i;
<a name="l00486"></a>00486             <span class="keywordflow">for</span>( i = 0 ; i &lt; m_allocated ; i++ )
<a name="l00487"></a>00487                 m_data[i] = SWAP32( m_data[i] );
<a name="l00488"></a>00488         };
<a name="l00489"></a>00489 <span class="preprocessor">    #else</span>
<a name="l00490"></a><a class="code" href="class_b_pack.html#1842e50c2b40c708860e3f90a1646e3f">00490</a> <span class="preprocessor"></span>        <span class="keyword">inline</span> <span class="keywordtype">void</span> SwapBytes() {};
<a name="l00491"></a>00491 <span class="preprocessor">    #endif</span>
<a name="l00492"></a>00492 <span class="preprocessor"></span>
<a name="l00493"></a>00493 }; <span class="comment">/* end definition of class BPack */</span>
<a name="l00494"></a>00494 
<a name="l00495"></a>00495 
<a name="l00496"></a>00496 <span class="preprocessor">#endif </span><span class="comment">/* _B_BYTE_STREAM_H_ */</span>
<a name="l00497"></a>00497 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Tue Jan 6 22:41:34 2009 for Autodesk DWF 3D Toolkit by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.5 </small></address>
</body>
</html>
